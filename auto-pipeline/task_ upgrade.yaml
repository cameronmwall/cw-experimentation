apiVersion: tekton.dev/v1beta1
kind: Task
metadata:
  name: upgrade
  namespace: default
spec:
  params:
  - name: higherVersion
    default: "2.4"
    description: The version to which to up.
    type: string
  steps:
  - args:
    - |-
      #!/bin/bash
      set -e

      oc project pipeline-test
      channel="release-"$(inputs.params.higherVersion)
      desiredVersion=$(inputs.params.higherVersion)".0"
      desiredCSV="advanced-cluster-management.v"$(inputs.params.higherVersion)".0"
      oc patch sub multicluster-hub-operator-subscription --type=merge -p '{"spec":{"channel":"'$channel'"}}'
      count=0
      while :
      do
          if oc get csv $desiredCSV ; then
            break
          else
            if [ $count -gt 20 ]; then
              echo "CSV not created in  time"
              exit 1
            else
              sleep 5
              count=$(( $count + 1 ))
            fi
          fi
        done
      
      count=0
      while :
      do  
          version=$(oc get mch multiclusterhub -o jsonpath='{.status.currentVersion}')
          if [ $version == $desiredVersion ]; then
              break
          else
              if [ $count -gt 120 ]; then
                  echo "CSV not created in  time"
                  exit 1
              else
                  sleep 5
                  count=$(( $count + 1 ))
              fi
          fi
      done

      count=0
      while :
      do  
          status=$(oc get mch multiclusterhub -o jsonpath='{.status.phase}')
          if [ $status == "Running" ]; then
              break
          else
              if [ $count -gt 120 ]; then
                  echo "MCH not updated in  time"
                  exit 1
              else
                  sleep 5
                  count=$(( $count + 1 ))
              fi
          fi
      done
    command:
    - /bin/bash
    - -c
    image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
    name: apply
    resources: {}
    workingDir: /workspace/source
  workspaces:
  - name: source